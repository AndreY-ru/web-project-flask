{% extends 'base.html'%}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block body %}

<main class="container">
  <section class="card profile">
    <div class="profile-img-container">
      <label for="profile-photo-input" class="profile-img">
        {% if student.profile_photo %}
        <img src="{{ url_for('static', filename=student.profile_photo) }}"
          alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è"
          class="profile-photo"
          onerror="this.onerror=null; this.parentElement.innerHTML='–§–æ—Ç–æ';">
        {% else %}
          <span>–§–æ—Ç–æ</span>
        {% endif %}
      </label>
      <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
      {% if student.profile_photo %}
        <button class="delete-photo-btn" onclick="deleteProfilePhoto()">–£–¥–∞–ª–∏—Ç—å</button>
      {% endif %}
    </div>
    
    <div class="profile-info">
      <h2>{{ student.surname }} {{ student.first_name }} {{ student.patronymic }}</h2>
      <p><strong>–ì–æ—Ä–æ–¥:</strong> {{ student.city }}</p>
      <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ student.birth_date.strftime('%d.%m.%Y') if student.birth_date else '‚Äî' }}</p>
      <p><strong>VK ID:</strong> {{ student.VK_id }}</p>
      <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:</strong> {{ student.phone or '‚Äî' }}</p>
      <p><strong>Email:</strong> {{ student.email }}</p>
      <p><strong>–ì—Ä—É–ø–ø–∞:</strong> {{ student.group_name }} ({{ student.group_short }}), <strong>–ö—É—Ä—Å:</strong> {{ student.course }}</p>
      <p><strong>–§–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è:</strong> {{ student.study_form }}</p>
      <p><strong>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> {{ student.orientation }}</p>
      <p><strong>–ö–∞—Ñ–µ–¥—Ä–∞:</strong> {{ student.department_name }} ({{ student.department_short }})</p>
      <p><strong>–ó–∞—á–µ—Ç–Ω–∞—è –∫–Ω–∏–∂–∫–∞:</strong> {{ student.record_book }}</p>
      <p><strong>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</strong> <a href="{{ student.schedule }}">–°—Å—ã–ª–∫–∞</a></p>
    </div>
  </section>

  <section class="card news">
    <h3>üì∞ –ù–æ–≤–æ—Å—Ç–∏</h3>
    <ul>
      {% for item in news %}
      <li>
        <span class="highlight">
          <a href="{{ url_for('news_detail', news_id=item.id) }}">{{ item.title }}</a>
        </span> ‚Äî {{ item.publish_date.strftime('%d.%m.%Y, %H:%M') }}
        <span class="author">{{ item.author }}</span>
      </li>
      {% else %}
      <li>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π</li>
      {% endfor %}
    </ul>
    <a href="{{ url_for('news_list') }}">
      <strong class="all-news">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏</strong>
    </a>
  </section>
  
</main>

<script>
  document.getElementById('profile-photo-input').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      uploadProfilePhoto(e.target.files[0]);
    }
  });

  function uploadProfilePhoto(file) {
    const formData = new FormData();
    formData.append('photo', file);
    
    fetch('/upload_profile_photo', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
    });
  }

  function deleteProfilePhoto() {
    if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è?')) {
      fetch('/delete_profile_photo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
      });
    }
  }
</script>
{% endblock %}